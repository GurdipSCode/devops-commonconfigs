# CodeRabbit Configuration for Terraform (Provider-Agnostic)
# Focuses on universal Terraform best practices regardless of provider
# Place this file at the root of your Terraform repository as .coderabbit.yaml

version: 1.0

# Language settings
language: en-US

# Early access features
early_access: true

# Review settings
reviews:
  # Review profile
  profile: assertive  # Strict for infrastructure code
  
  # Request changes workflow
  request_changes_workflow: true
  
  # High level summary
  high_level_summary: true
  
  # Poem style for summaries
  poem: false
  
  # Review status
  review_status: true
  
  # Collapse walkthrough
  collapse_walkthrough: false
  
  # Auto review
  auto_review:
    enabled: true
    
    # Ignore specific file patterns
    ignore_patterns:
      - "**/*.md"
      - "**/LICENSE"
      - "**/.gitignore"
      - "**/CHANGELOG.md"
      - "**/.terraform/**"
      - "**/.terraform.lock.hcl"
      - "**/terraform.tfstate*"
    
    # Auto-approve trivial changes
    auto_approve:
      enabled: true
      conditions:
        - type: "documentation"
          max_files: 3
        - type: "formatting"
          max_lines: 30
  
  # Tools to use
  tools:
    # Terraform validation
    terraform:
      enabled: true
    
    # Security scanning (provider-agnostic)
    security:
      enabled: true

# Path-specific instructions
path_instructions:
  # Main Terraform files
  - path: "**/*.tf"
    instructions: |
      For Terraform files, check PROVIDER-AGNOSTIC issues:
      
      1. HARDCODED SECRETS (CRITICAL)
         - No hardcoded passwords, API tokens, SSH keys
         - All secrets must use sensitive = true
         - Never commit credentials to version control
         - Use variables for all sensitive data
         
         Examples to flag:
         ```hcl
         # ‚ùå CRITICAL: Hardcoded password
         password = "MyPassword123!"
         
         # ‚ùå CRITICAL: Hardcoded API token
         api_token = "abc123def456"
         
         # ‚ùå CRITICAL: Hardcoded SSH key
         ssh_private_key = "-----BEGIN RSA PRIVATE KEY-----..."
         
         # ‚ùå CRITICAL: Hardcoded certificate
         certificate = "-----BEGIN CERTIFICATE-----..."
         ```
         
         Correct approach:
         ```hcl
         variable "password" {
           description = "Password from vault/secrets manager"
           type        = string
           sensitive   = true
         }
         
         variable "api_token" {
           description = "API token for provider authentication"
           type        = string
           sensitive   = true
         }
         ```
      
      2. FOR_EACH VS COUNT (BEST PRACTICE)
         - Prefer for_each over count
         - count breaks when items removed from middle
         - for_each uses keys, more stable
         - Document why count is used if necessary
         
         Flag:
         ```hcl
         # ‚ùå BAD: Using count
         resource "vsphere_virtual_machine" "web" {
           count = 3
           name  = "web-${count.index}"
         }
         ```
         
         Suggest:
         ```hcl
         # ‚úÖ GOOD: Using for_each
         resource "vsphere_virtual_machine" "web" {
           for_each = toset(["web-1", "web-2", "web-3"])
           name     = each.key
         }
         ```
      
      3. VARIABLE VALIDATION (BEST PRACTICE)
         - All variables should have validation where appropriate
         - Validate enums, ranges, patterns
         - Add descriptions to all variables
         - Use proper type constraints
         
         Flag:
         ```hcl
         # ‚ùå BAD: No validation
         variable "environment" {
           type = string
         }
         
         variable "vm_count" {
           type = number
         }
         ```
         
         Suggest:
         ```hcl
         # ‚úÖ GOOD: With validation
         variable "environment" {
           description = "Environment name (dev, staging, prod)"
           type        = string
           
           validation {
             condition     = contains(["dev", "staging", "prod"], var.environment)
             error_message = "Environment must be dev, staging, or prod"
           }
         }
         
         variable "vm_count" {
           description = "Number of VMs to create"
           type        = number
           
           validation {
             condition     = var.vm_count > 0 && var.vm_count <= 20
             error_message = "VM count must be between 1 and 20"
           }
         }
         ```
      
      4. LIFECYCLE RULES (CRITICAL RESOURCES)
         - Use prevent_destroy for critical resources
         - Use create_before_destroy for zero-downtime
         - Document why lifecycle rules exist
         
         Flag missing lifecycle on:
         - Databases, storage systems
         - Production VMs
         - Network infrastructure
         
         ```hcl
         # ‚úÖ GOOD: Protected critical resource
         resource "vsphere_virtual_machine" "database" {
           lifecycle {
             prevent_destroy = true  # Prevent accidental deletion
           }
         }
         
         resource "proxmox_vm_qemu" "app" {
           lifecycle {
             create_before_destroy = true  # Zero-downtime updates
           }
         }
         ```
      
      5. RESOURCE NAMING CONVENTIONS
         - Use consistent naming scheme
         - Include environment in names
         - Use descriptive, not generic names
         - Follow organization standards
         
         Flag:
         ```hcl
         # ‚ùå BAD: Generic names
         resource "vsphere_virtual_machine" "vm1" {
           name = "server"
         }
         ```
         
         Suggest:
         ```hcl
         # ‚úÖ GOOD: Descriptive names
         resource "vsphere_virtual_machine" "web_server_prod" {
           name = "${var.project}-${var.environment}-web-01"
         }
         ```
      
      6. DEPENDS_ON USAGE
         - Only use when implicit dependencies insufficient
         - Document why explicit dependency needed
         - Avoid circular dependencies
         - Consider if resource references can replace depends_on
         
         Flag overuse:
         ```hcl
         # ‚ö†Ô∏è WARNING: Unnecessary depends_on
         resource "vsphere_virtual_machine" "app" {
           depends_on = [vsphere_virtual_machine.db]
           network_interface {
             # Could reference db.ip directly
           }
         }
         ```
      
      7. DYNAMIC BLOCKS
         - Use for repeated nested blocks
         - Keep logic simple and readable
         - Document complex dynamic blocks
         - Avoid deeply nested dynamics
         
         Good:
         ```hcl
         dynamic "disk" {
           for_each = var.additional_disks
           content {
             label            = disk.value.label
             size             = disk.value.size
             thin_provisioned = disk.value.thin_provisioned
           }
         }
         ```
         
         Flag if too complex or deeply nested
      
      8. LOCALS VS VARIABLES
         - Variables: Input from outside
         - Locals: Computed/derived values
         - Don't compute values in variables
         - Don't use locals for external input
         
         Flag:
         ```hcl
         # ‚ùå BAD: Computing in variable
         variable "name" {
           default = "${var.project}-${var.env}"  # Can't do this!
         }
         ```
         
         Suggest:
         ```hcl
         # ‚úÖ GOOD: Use locals for computation
         locals {
           name_prefix = "${var.project}-${var.environment}"
           common_tags = {
             Environment = var.environment
             ManagedBy   = "Terraform"
           }
         }
         ```
      
      9. RESOURCE TAGS/LABELS
         - All resources should have tags/labels
         - Include: Environment, Owner, ManagedBy, Project
         - Use consistent tag schema
         - Consider provider default_tags if available
         
         Flag resources without tags
      
      10. MOVED BLOCKS (REFACTORING)
          - Use when refactoring resource addresses
          - Prevents destroy/recreate
          - Document what was moved and why
          
          ```hcl
          moved {
            from = vsphere_virtual_machine.old_name
            to   = vsphere_virtual_machine.new_name
          }
          ```
      
      11. NULL RESOURCE ABUSE
          - Flag overuse of null_resource
          - Suggest proper resource types instead
          - Document legitimate null_resource uses
          
          Flag:
          ```hcl
          # ‚ö†Ô∏è WARNING: Consider proper resource type
          resource "null_resource" "configure_vm" {
            provisioner "local-exec" {
              command = "ansible-playbook ..."
            }
          }
          ```
      
      12. PROVISIONERS
          - Flag use of provisioners (anti-pattern)
          - Suggest proper configuration management
          - Only accept for rare edge cases
          - Require justification comment
          
          ```hcl
          # ‚ö†Ô∏è WARNING: Provisioners are anti-pattern
          resource "vsphere_virtual_machine" "web" {
            provisioner "remote-exec" {
              # Should use cloud-init, Ansible, etc.
            }
          }
          ```
      
      13. DATA SOURCE VALIDATION
          - Data sources should have validation
          - Check data source exists before use
          - Handle missing data sources gracefully
          
          Flag:
          ```hcl
          # ‚ö†Ô∏è WARNING: No validation on data source
          data "vsphere_datacenter" "dc" {
            name = var.datacenter_name  # What if doesn't exist?
          }
          
          resource "vsphere_virtual_machine" "web" {
            datacenter_id = data.vsphere_datacenter.dc.id  # Will fail if DC not found
          }
          ```
          
          Suggest:
          ```hcl
          # ‚úÖ GOOD: Validate data source in variable
          variable "datacenter_name" {
            description = "vSphere datacenter name. Must exist in vCenter."
            type        = string
            
            validation {
              condition     = length(var.datacenter_name) > 0
              error_message = "Datacenter name cannot be empty"
            }
          }
          
          # Better: Use precondition (Terraform 1.2+)
          data "vsphere_datacenter" "dc" {
            name = var.datacenter_name
            
            lifecycle {
              precondition {
                condition     = self.id != ""
                error_message = "Datacenter '${var.datacenter_name}' not found in vCenter"
              }
            }
          }
          ```
      
      14. RESOURCE TIMEOUTS
          - Add timeouts to prevent infinite hangs
          - Critical for VM creation, network operations
          - Document why specific timeout values chosen
          
          Flag:
          ```hcl
          # ‚ö†Ô∏è WARNING: No timeout - could hang indefinitely
          resource "vsphere_virtual_machine" "web" {
            name = "web-server"
            # ... config
          }
          ```
          
          Suggest:
          ```hcl
          # ‚úÖ GOOD: With timeouts
          resource "vsphere_virtual_machine" "web" {
            name = "web-server"
            
            timeouts {
              create = "60m"  # VM creation can take time
              update = "30m"
              delete = "20m"
            }
          }
          
          resource "proxmox_vm_qemu" "app" {
            timeouts {
              create = "45m"
              update = "30m"
              delete = "15m"
            }
          }
          ```
      
      15. IGNORE_CHANGES ABUSE
          - Flag overuse of ignore_changes
          - Each ignore_changes should be commented
          - Consider if resource should be managed differently
          
          Flag:
          ```hcl
          # ‚ö†Ô∏è WARNING: Too many ignore_changes
          resource "vsphere_virtual_machine" "web" {
            lifecycle {
              ignore_changes = [
                num_cpus,
                memory,
                disk,
                network_interface,
                guest_id,
                # Ignoring too much = not really managing this resource!
              ]
            }
          }
          ```
          
          Suggest:
          ```hcl
          # ‚úÖ GOOD: Justified ignore_changes
          resource "vsphere_virtual_machine" "web" {
            lifecycle {
              # Ignore tags because they're managed by external system
              ignore_changes = [tags]
            }
          }
          ```
      
      16. HARDCODED IP ADDRESSES
          - Flag hardcoded IP addresses in config
          - Should use variables or IPAM
          - Document IP allocation scheme
          
          Flag:
          ```hcl
          # ‚ö†Ô∏è WARNING: Hardcoded IP
          resource "proxmox_vm_qemu" "web" {
            ipconfig0 = "ip=192.168.1.100/24,gw=192.168.1.1"
          }
          ```
          
          Suggest:
          ```hcl
          # ‚úÖ GOOD: IP from variable or IPAM
          resource "proxmox_vm_qemu" "web" {
            ipconfig0 = "ip=${var.vm_ip_address}/${var.subnet_mask},gw=${var.gateway}"
          }
          
          # Or better: Dynamic from IPAM
          data "netbox_ip_address" "web" {
            ...
          }
          
          resource "proxmox_vm_qemu" "web" {
            ipconfig0 = "ip=${data.netbox_ip_address.web.ip_address}/24,gw=${var.gateway}"
          }
          ```
      
      17. OUTPUT SENSITIVITY
          - Flag outputs that expose secrets without sensitive=true
          - Check for password, token, key in output names
          - Verify sensitive data marked correctly
          
          Flag:
          ```hcl
          # ‚ö†Ô∏è WARNING: Secret in output without sensitive flag
          output "database_password" {
            value = random_password.db.result
          }
          
          output "api_token" {
            value = var.api_token
          }
          ```
          
          Require:
          ```hcl
          # ‚úÖ GOOD: Sensitive outputs marked
          output "database_password" {
            description = "Database password"
            value       = random_password.db.result
            sensitive   = true
          }
          
          output "vm_ssh_private_key" {
            description = "SSH private key for VM access"
            value       = tls_private_key.vm.private_key_pem
            sensitive   = true
          }
          ```
      
      18. MODULE SOURCE PINNING
          - Flag module sources without version pinning
          - Git URLs should have ref parameter
          - Registry modules should have version
          
          Flag:
          ```hcl
          # ‚ö†Ô∏è WARNING: No version pinning
          module "network" {
            source = "git::https://github.com/company/terraform-modules.git//network"
          }
          
          module "compute" {
            source = "app.terraform.io/company/compute/vsphere"
          }
          ```
          
          Require:
          ```hcl
          # ‚úÖ GOOD: Pinned versions
          module "network" {
            source = "git::https://github.com/company/terraform-modules.git//network?ref=v1.2.3"
          }
          
          module "compute" {
            source  = "app.terraform.io/company/compute/vsphere"
            version = "~> 2.1.0"
          }
          ```
      
      19. CONNECTION BLOCK SECURITY
          - Flag connection blocks with hardcoded credentials
          - Verify SSH keys not exposed
          - Check for insecure connection types
          
          Flag:
          ```hcl
          # üîê CRITICAL: Hardcoded credentials in connection
          resource "null_resource" "configure" {
            connection {
              type     = "ssh"
              host     = vsphere_virtual_machine.web.default_ip_address
              user     = "root"
              password = "MyPassword123!"  # ‚Üê Hardcoded!
            }
          }
          ```
          
          Require:
          ```hcl
          # ‚úÖ GOOD: Credentials from variables
          resource "null_resource" "configure" {
            connection {
              type        = "ssh"
              host        = vsphere_virtual_machine.web.default_ip_address
              user        = var.ssh_user
              private_key = var.ssh_private_key  # From variable
            }
          }
          ```
      
      20. LOCAL-EXEC COMMAND INJECTION
          - Flag local-exec with string interpolation
          - Check for unsanitized variable usage
          - Suggest safer alternatives
          
          Flag:
          ```hcl
          # üîê CRITICAL: Command injection risk
          resource "null_resource" "deploy" {
            provisioner "local-exec" {
              command = "ssh ${var.hostname} 'echo ${var.user_input}'"
              # ‚Üê If user_input contains '; rm -rf /', you're hosed!
            }
          }
          ```
          
          Suggest:
          ```hcl
          # ‚úÖ BETTER: Use proper escaping or avoid local-exec
          resource "null_resource" "deploy" {
            provisioner "local-exec" {
              command = "ssh ${var.hostname} 'echo ${jsonencode(var.user_input)}'"
            }
          }
          
          # ‚úÖ BEST: Don't use local-exec, use proper resources
          ```
      
      21. COMPLEX CONDITIONAL LOGIC
          - Flag deeply nested ternary operators
          - Suggest using locals for clarity
          - Limit to 2 levels of nesting
          
          Flag:
          ```hcl
          # ‚ö†Ô∏è WARNING: Too complex
          resource "vsphere_virtual_machine" "web" {
            num_cpus = var.environment == "prod" ? (var.size == "large" ? 8 : 4) : (var.size == "large" ? 4 : 2)
            memory   = var.environment == "prod" ? (var.size == "large" ? 16384 : 8192) : (var.size == "large" ? 8192 : 4096)
          }
          ```
          
          Suggest:
          ```hcl
          # ‚úÖ GOOD: Use locals
          locals {
            vm_specs = {
              prod = {
                large  = { cpus = 8, memory = 16384 }
                medium = { cpus = 4, memory = 8192 }
              }
              dev = {
                large  = { cpus = 4, memory = 8192 }
                medium = { cpus = 2, memory = 4096 }
              }
            }
            
            selected_spec = local.vm_specs[var.environment][var.size]
          }
          
          resource "vsphere_virtual_machine" "web" {
            num_cpus = local.selected_spec.cpus
            memory   = local.selected_spec.memory
          }
          ```
      
      22. TEMPLATEFILE SECURITY
          - Flag templatefile() with user input
          - Check for template injection risks
          - Validate template paths
          
          Flag:
          ```hcl
          # üîê WARNING: Template injection risk
          resource "proxmox_vm_qemu" "web" {
            cicustom = templatefile("${var.user_path}/cloud-init.yaml", {
              # ‚Üê User controls template path!
            })
          }
          ```
          
          Require:
          ```hcl
          # ‚úÖ GOOD: Fixed template path
          resource "proxmox_vm_qemu" "web" {
            cicustom = templatefile("${path.module}/templates/cloud-init.yaml", {
              hostname = var.hostname
            })
          }
          ```
      
      23. ERROR MESSAGES IN VALIDATION
          - All validation rules must have clear error_message
          - Error messages should explain what's wrong AND how to fix
          - Include examples in error messages
          
          Flag:
          ```hcl
          # ‚ö†Ô∏è WARNING: Vague error message
          variable "vm_name" {
            validation {
              condition     = can(regex("^[a-z0-9-]+$", var.vm_name))
              error_message = "Invalid name"
            }
          }
          ```
          
          Require:
          ```hcl
          # ‚úÖ GOOD: Clear, actionable error message
          variable "vm_name" {
            validation {
              condition     = can(regex("^[a-z0-9-]+$", var.vm_name))
              error_message = "VM name must contain only lowercase letters, numbers, and hyphens. Got '${var.vm_name}'. Example: 'web-server-01'"
            }
          }
          ```
      
      24. FILE ORGANIZATION
          - Flag files with >500 lines
          - Suggest splitting into logical files
          - Check for proper separation of concerns
          
          Flag:
          ```
          main.tf (1500 lines)  # ‚Üê Too large!
          ```
          
          Suggest:
          ```
          # ‚úÖ GOOD: Organized structure
          main.tf           # Entry point, module calls
          variables.tf      # Variable definitions
          outputs.tf        # Output definitions
          data.tf           # Data sources
          locals.tf         # Local values
          network.tf        # Network resources
          compute.tf        # Compute resources
          storage.tf        # Storage resources
          versions.tf       # Provider versions
          ```
      
      25. WORKSPACE USAGE
          - Flag terraform workspace usage
          - Workspaces can cause state management issues
          - Suggest separate state files instead
          
          Flag:
          ```hcl
          # ‚ö†Ô∏è WARNING: Workspace-dependent logic
          resource "vsphere_virtual_machine" "web" {
            name = "${terraform.workspace}-web-server"
          }
          ```
          
          Suggest:
          ```hcl
          # ‚úÖ BETTER: Use separate directories/states
          # dev/terraform.tf
          # staging/terraform.tf  
          # prod/terraform.tf
          
          # Or use environment variable
          resource "vsphere_virtual_machine" "web" {
            name = "${var.environment}-web-server"
          }
          ```
      
      26. CIDR CALCULATIONS
          - Verify CIDR block calculations are correct
          - Check for subnet overlaps
          - Validate cidrsubnet() usage
          
          Flag:
          ```hcl
          # ‚ö†Ô∏è WARNING: Manual subnet calculation - error-prone
          locals {
            subnet_1 = "10.0.1.0/24"
            subnet_2 = "10.0.2.0/24"
            subnet_3 = "10.0.3.0/24"
          }
          ```
          
          Suggest:
          ```hcl
          # ‚úÖ GOOD: Use cidrsubnet()
          variable "vpc_cidr" {
            default = "10.0.0.0/16"
          }
          
          locals {
            subnet_cidrs = [
              cidrsubnet(var.vpc_cidr, 8, 1),  # 10.0.1.0/24
              cidrsubnet(var.vpc_cidr, 8, 2),  # 10.0.2.0/24
              cidrsubnet(var.vpc_cidr, 8, 3),  # 10.0.3.0/24
            ]
          }
          ```
      
      27. PERFORMANCE - LARGE LOOPS
          - Flag for_each with >100 items
          - Warn about performance implications
          - Suggest chunking or alternative approach
          
          Flag:
          ```hcl
          # ‚ö†Ô∏è WARNING: Creating 500 VMs in single apply
          resource "vsphere_virtual_machine" "nodes" {
            for_each = toset(range(1, 501))  # 500 VMs!
            # This will take hours and likely time out
          }
          ```
          
          Suggest:
          ```hcl
          # ‚úÖ BETTER: Create in batches or use different approach
          # Consider: VM templates, cloning, or external orchestration
          ```
      
      28. IMPORT BLOCKS (Terraform 1.5+)
          - Encourage use of import blocks over terraform import
          - Verify import blocks have proper to address
          - Document what's being imported and why
          
          Good:
          ```hcl
          # ‚úÖ GOOD: Import block with documentation
          import {
            # Importing existing production database VM to Terraform management
            # VM was created manually in vCenter on 2024-01-15
            to = vsphere_virtual_machine.prod_db
            id = "vm-123456"
          }
          
          resource "vsphere_virtual_machine" "prod_db" {
            # Configuration matches existing VM
            name = "prod-database"
            # ...
          }
          ```
      
      29. SENSITIVE DATA IN NON-SENSITIVE CONTEXTS
          - Flag sensitive variables used in non-sensitive outputs
          - Check sensitive data in resource names/tags
          - Verify sensitive values not in count/for_each keys
          
          Flag:
          ```hcl
          # üîê CRITICAL: Sensitive data in resource name
          variable "api_key" {
            sensitive = true
          }
          
          resource "null_resource" "deploy" {
            name = "deploy-${var.api_key}"  # ‚Üê Exposes secret in name!
          }
          
          # üîê CRITICAL: Sensitive in output without sensitive flag
          output "connection_string" {
            # Contains password but not marked sensitive
            value = "host=${var.db_host};password=${var.db_password}"
          }
          ```
          
          Require:
          ```hcl
          # ‚úÖ GOOD: Separate sensitive and non-sensitive
          output "connection_string" {
            value     = "host=${var.db_host};password=${var.db_password}"
            sensitive = true
          }
          ```
      
      30. BACKEND PARTIAL CONFIGURATION
          - Backend credentials should use partial config
          - Never hardcode backend credentials in .tf files
          - Use backend config file or environment variables
          
          Flag:
          ```hcl
          # üîê CRITICAL: Backend credentials in code
          terraform {
            backend "consul" {
              address  = "consul.local:8500"
              username = "terraform"
              password = "MyPassword123!"  # ‚Üê Hardcoded!
            }
          }
          ```
          
          Require:
          ```hcl
          # ‚úÖ GOOD: Partial configuration
          terraform {
            backend "consul" {
              address = "consul.local:8500"
              # username and password set via:
              # - backend config file: -backend-config=backend.hcl
              # - environment: TF_CLI_ARGS_init="-backend-config=username=... -backend-config=password=..."
            }
          }
          ```
      
      31. RANDOM RESOURCE LIFECYCLE
          - random_* resources should have keepers
          - Explain what triggers regeneration
          - Consider using random_id for short IDs
          
          Flag:
          ```hcl
          # ‚ö†Ô∏è WARNING: No keepers - regenerates every apply
          resource "random_password" "db" {
            length = 16
          }
          ```
          
          Require:
          ```hcl
          # ‚úÖ GOOD: With keepers
          resource "random_password" "db" {
            length = 16
            
            keepers = {
              # Regenerate when VM is replaced
              vm_id = vsphere_virtual_machine.db.id
            }
          }
          ```
      
      32. NON-DETERMINISTIC FUNCTIONS
          - Flag timestamp() usage (always changes)
          - Flag uuid() usage (always changes)
          - Suggest using plantimestamp() or terraform_data
          
          Flag:
          ```hcl
          # ‚ö†Ô∏è WARNING: Non-deterministic function
          resource "vsphere_virtual_machine" "web" {
            annotation = "Created at ${timestamp()}"
            # ‚Üê This changes every plan, causing constant drift!
          }
          ```
          
          Suggest:
          ```hcl
          # ‚úÖ GOOD: Use plantimestamp() for creation time
          resource "vsphere_virtual_machine" "web" {
            annotation = "Created at ${plantimestamp()}"
          }
          
          # Or better: Use lifecycle ignore_changes
          resource "vsphere_virtual_machine" "web" {
            annotation = "Created at ${timestamp()}"
            
            lifecycle {
              ignore_changes = [annotation]
            }
          }
          ```
      
      33. FILE FUNCTION SECURITY
          - Check file() paths are not user-controlled
          - Validate file paths exist
          - Consider using templatefile() instead
          
          Flag:
          ```hcl
          # üîê CRITICAL: User-controlled file path
          resource "proxmox_vm_qemu" "web" {
            ssh_private_key = file(var.key_path)
            # ‚Üê User could set to /etc/passwd!
          }
          ```
          
          Require:
          ```hcl
          # ‚úÖ GOOD: Fixed path with validation
          variable "key_path" {
            validation {
              condition     = can(regex("^[a-zA-Z0-9/_.-]+\\.pem$", var.key_path))
              error_message = "Key path must be a .pem file"
            }
          }
          
          # Better: Use fixed path
          resource "proxmox_vm_qemu" "web" {
            ssh_private_key = file("${path.module}/keys/id_rsa.pem")
          }
          ```
      
      34. TRY/CAN/COALESCE USAGE
          - Prefer can() for validation
          - Use try() for optional attributes
          - Use coalesce() for fallback values
          - Document error handling logic
          
          Flag:
          ```hcl
          # ‚ö†Ô∏è WARNING: try() without comment
          num_cpus = try(var.vm_config.cpus, 4)
          ```
          
          Suggest:
          ```hcl
          # ‚úÖ GOOD: Documented try()
          # Default to 4 CPUs if not specified in vm_config
          num_cpus = try(var.vm_config.cpus, 4)
          
          # ‚úÖ GOOD: Use can() in validation
          variable "cidr_block" {
            validation {
              condition     = can(cidrhost(var.cidr_block, 0))
              error_message = "Must be valid CIDR"
            }
          }
          ```
      
      35. TYPE COERCION
          - Prefer explicit type conversion
          - Flag implicit type conversions
          - Use tostring(), tonumber(), tobool() explicitly
          
          Flag:
          ```hcl
          # ‚ö†Ô∏è WARNING: Implicit type conversion
          resource "vsphere_virtual_machine" "web" {
            annotation = var.vm_id  # number ‚Üí string implicitly
          }
          ```
          
          Suggest:
          ```hcl
          # ‚úÖ GOOD: Explicit conversion
          resource "vsphere_virtual_machine" "web" {
            annotation = tostring(var.vm_id)
          }
          ```
      
      36. MAP MERGE CONFLICTS
          - Check merge() for potential key conflicts
          - Document merge precedence
          - Consider using deep merge when needed
          
          Flag:
          ```hcl
          # ‚ö†Ô∏è WARNING: Potential merge conflict
          locals {
            default_tags = { Environment = "dev" }
            custom_tags  = var.tags
            
            # If var.tags has Environment, which wins?
            all_tags = merge(local.default_tags, local.custom_tags)
          }
          ```
          
          Require:
          ```hcl
          # ‚úÖ GOOD: Document merge behavior
          locals {
            # Custom tags override defaults (right wins)
            all_tags = merge(local.default_tags, local.custom_tags)
          }
          
          # Or validate no conflicts
          variable "tags" {
            validation {
              condition = !contains(keys(var.tags), "Environment")
              error_message = "Cannot override Environment tag"
            }
          }
          ```
      
      37. JSONENCODE/YAMLENCODE USAGE
          - Use jsonencode() instead of manual JSON strings
          - Use yamlencode() for YAML generation
          - Validate JSON/YAML structure
          
          Flag:
          ```hcl
          # ‚ö†Ô∏è WARNING: Manual JSON string
          extra_config = "{\"disk.enableUUID\": \"true\"}"
          ```
          
          Suggest:
          ```hcl
          # ‚úÖ GOOD: Use jsonencode()
          extra_config = jsonencode({
            "disk.enableUUID" = "true"
          })
          ```
      
      38. PRECONDITIONS AND POSTCONDITIONS
          - Use preconditions to validate inputs
          - Use postconditions to validate outputs
          - Provide clear error messages
          
          Good:
          ```hcl
          # ‚úÖ GOOD: Precondition on resource
          resource "vsphere_virtual_machine" "web" {
            num_cpus = var.cpu_count
            
            lifecycle {
              precondition {
                condition     = var.cpu_count >= 2
                error_message = "Production VMs require at least 2 CPUs"
              }
              
              postcondition {
                condition     = self.power_state == "poweredOn"
                error_message = "VM failed to power on"
              }
            }
          }
          ```
      
      39. CHECK BLOCKS (Terraform 1.5+)
          - Use check blocks for assertions
          - Validate infrastructure state
          - Document what's being checked
          
          Good:
          ```hcl
          # ‚úÖ GOOD: Check block for validation
          check "vm_network_connectivity" {
            data "http" "vm_health" {
              url = "http://${vsphere_virtual_machine.web.default_ip_address}/health"
            }
            
            assert {
              condition     = data.http.vm_health.status_code == 200
              error_message = "VM health check failed"
            }
          }
          ```
      
      40. PROVIDER ALIASES IN MODULES
          - Modules should not configure providers
          - Use required_providers in modules
          - Pass provider aliases explicitly
          
          Flag:
          ```hcl
          # ‚ùå BAD: Module configuring provider
          # module/main.tf
          provider "vsphere" {
            user = var.vsphere_user
            # Modules shouldn't configure providers!
          }
          ```
          
          Require:
          ```hcl
          # ‚úÖ GOOD: Module declares required providers
          # module/versions.tf
          terraform {
            required_providers {
              vsphere = {
                source  = "hashicorp/vsphere"
                version = "~> 2.5"
              }
            }
          }
          
          # Root module passes provider
          module "vms" {
            source = "./modules/vms"
            providers = {
              vsphere = vsphere.datacenter1
            }
          }
          ```
      
      41. MULTIPLE PROVIDER INSTANCES
          - Document why multiple providers needed
          - Use clear alias names
          - Validate provider configuration
          
          Good:
          ```hcl
          # ‚úÖ GOOD: Clear provider aliases
          provider "vsphere" {
            alias = "datacenter1"
            vsphere_server = "vcenter1.company.local"
          }
          
          provider "vsphere" {
            alias = "datacenter2"
            vsphere_server = "vcenter2.company.local"
          }
          
          # Use in resources
          resource "vsphere_virtual_machine" "web_dc1" {
            provider = vsphere.datacenter1
          }
          ```
      
      42. PESSIMISTIC VERSION CONSTRAINTS
          - Use ~> for minor version updates
          - Document why specific versions required
          - Avoid >= (too permissive)
          
          Flag:
          ```hcl
          # ‚ö†Ô∏è WARNING: Too permissive
          terraform {
            required_providers {
              vsphere = {
                source  = "hashicorp/vsphere"
                version = ">= 2.0"  # ‚Üê Allows 3.0, 4.0, breaking changes!
              }
            }
          }
          ```
          
          Require:
          ```hcl
          # ‚úÖ GOOD: Pessimistic constraint
          terraform {
            required_providers {
              vsphere = {
                source  = "hashicorp/vsphere"
                version = "~> 2.5"  # Allows 2.5.x, not 3.0
              }
            }
          }
          ```
      
      43. DEPRECATED RESOURCE TYPES
          - Flag use of deprecated resources
          - Suggest replacement resources
          - Link to migration guide
          
          Example checks:
          - vsphere_virtual_machine_snapshot (deprecated)
          - Old resource types vs new
      
      44. COUNT.INDEX USAGE
          - Even with count, use it properly
          - Don't use in resource names without padding
          - Consider if for_each is better
          
          Flag:
          ```hcl
          # ‚ö†Ô∏è WARNING: count.index without padding
          resource "vsphere_virtual_machine" "web" {
            count = 10
            name  = "web-${count.index}"
            # Creates: web-0, web-1, ... web-9, web-10
            # Inconsistent length!
          }
          ```
          
          Suggest:
          ```hcl
          # ‚úÖ GOOD: Padded index
          resource "vsphere_virtual_machine" "web" {
            count = 10
            name  = format("web-%02d", count.index)
            # Creates: web-00, web-01, ... web-09, web-10
          }
          
          # ‚úÖ BETTER: Use for_each
          resource "vsphere_virtual_machine" "web" {
            for_each = toset([for i in range(10) : format("web-%02d", i)])
            name     = each.key
          }
          ```
      
      45. SELF REFERENCE USAGE
          - Use self for referencing current resource
          - Explain self in preconditions/postconditions
          - Validate self usage
          
          Good:
          ```hcl
          # ‚úÖ GOOD: Using self
          resource "vsphere_virtual_machine" "web" {
            lifecycle {
              postcondition {
                condition     = self.power_state == "poweredOn"
                error_message = "VM ${self.name} failed to power on"
              }
            }
          }
          ```
      
      46. REMOTE STATE DATA SOURCES
          - Validate remote state references
          - Document what's being referenced
          - Handle missing state gracefully
          
          Good:
          ```hcl
          # ‚úÖ GOOD: Remote state with error handling
          data "terraform_remote_state" "network" {
            backend = "consul"
            config = {
              path = "network/terraform.tfstate"
            }
          }
          
          locals {
            # Handle missing output gracefully
            vpc_id = try(
              data.terraform_remote_state.network.outputs.vpc_id,
              var.default_vpc_id
            )
          }
          ```
      
      47. MOVED BLOCKS DOCUMENTATION
          - Document all moved blocks
          - Explain what was refactored
          - Include date and reason
          
          Good:
          ```hcl
          # ‚úÖ GOOD: Documented moved block
          # Refactored 2024-12-01: Renamed for consistency
          # Old name: vsphere_virtual_machine.vm_web_server
          # New name: vsphere_virtual_machine.web_server
          moved {
            from = vsphere_virtual_machine.vm_web_server
            to   = vsphere_virtual_machine.web_server
          }
          ```
      
      48. REPLACE_TRIGGERED_BY USAGE
          - Document why resource needs replacement
          - Use for dependencies not tracked by Terraform
          - Explain trigger conditions
          
          Good:
          ```hcl
          # ‚úÖ GOOD: Documented replace trigger
          resource "null_resource" "vm_provisioner" {
            # Replace when VM or config changes
            replace_triggered_by = [
              vsphere_virtual_machine.web.id,
              local_file.config.id
            ]
          }
          ```
      
      49. VARIABLE DEFAULT VALUES
          - Secrets should never have defaults
          - Sensitive data should never have defaults
          - Document why defaults are safe
          
          Flag:
          ```hcl
          # üîê CRITICAL: Secret with default
          variable "admin_password" {
            sensitive = true
            default   = "changeme"  # ‚Üê Never!
          }
          ```
          
          Require:
          ```hcl
          # ‚úÖ GOOD: Secret without default
          variable "admin_password" {
            description = "Admin password from vault"
            type        = string
            sensitive   = true
            # No default!
          }
          ```
      
      50. TERRAFORM_DATA RESOURCE
          - Use terraform_data for triggers
          - Replace null_resource where appropriate
          - Document trigger behavior
          
          Good:
          ```hcl
          # ‚úÖ GOOD: Using terraform_data
          resource "terraform_data" "vm_replacement" {
            input = var.vm_configuration_version
          }
          
          resource "vsphere_virtual_machine" "web" {
            lifecycle {
              replace_triggered_by = [terraform_data.vm_replacement]
            }
          }
          ```
  
  # Variables files
  - path: "**/*variables.tf"
    instructions: |
      For variable files, check:
      
      1. ALL VARIABLES MUST HAVE:
         - description (mandatory)
         - type (mandatory)
         - validation (when appropriate)
         - default (when appropriate, never for secrets)
      
      2. SECRETS MUST HAVE:
         - sensitive = true (mandatory)
         - no default value (mandatory)
         - clear description of where to get value
      
      3. VALIDATION RULES FOR:
         - Enums (environment: dev/staging/prod)
         - Ranges (counts, sizes)
         - Patterns (names, IDs, IPs)
         - CIDR blocks
         - File paths
      
      4. TYPE CONSTRAINTS:
         - Use specific types, not any
         - Use object() over map() when structure known
         - Use list(string) over list(any)
         - Define object schemas completely
      
      Flag:
      ```hcl
      # ‚ùå BAD: Multiple issues
      variable "env" {
        type = string
      }
      
      variable "password" {
        default = "changeme"
      }
      
      variable "config" {
        type = any  # Too generic
      }
      ```
      
      Require:
      ```hcl
      # ‚úÖ GOOD: Complete variables
      variable "environment" {
        description = "Environment name (dev, staging, prod)"
        type        = string
        
        validation {
          condition     = contains(["dev", "staging", "prod"], var.environment)
          error_message = "Must be dev, staging, or prod"
        }
      }
      
      variable "password" {
        description = "Password from vault (use TF_VAR_password)"
        type        = string
        sensitive   = true
        # No default!
      }
      
      variable "vm_config" {
        description = "VM configuration object"
        type = object({
          cpus   = number
          memory = number
          disks  = list(object({
            size = number
            thin = bool
          }))
        })
      }
      ```
  
  # Outputs files
  - path: "**/*outputs.tf"
    instructions: |
      For output files, check:
      
      1. ALL OUTPUTS MUST HAVE:
         - description (mandatory)
         - sensitive = true if contains secrets
      
      2. OUTPUT NAMING:
         - Descriptive names
         - Consistent with variable naming
         - Consider module consumers
      
      3. SECURITY:
         - Mark sensitive outputs as sensitive
         - Don't expose secrets unnecessarily
      
      Flag:
      ```hcl
      # ‚ùå BAD: No description, secret not marked
      output "ip" {
        value = vsphere_virtual_machine.db.default_ip_address
      }
      
      output "password" {
        value = random_password.db.result
      }
      ```
      
      Require:
      ```hcl
      # ‚úÖ GOOD: Complete outputs
      output "database_ip_address" {
        description = "IP address of database VM"
        value       = vsphere_virtual_machine.db.default_ip_address
      }
      
      output "database_password" {
        description = "Database admin password"
        value       = random_password.db.result
        sensitive   = true
      }
      ```
  
  # Terraform configuration files
  - path: "**/terraform.tf"
    instructions: |
      For terraform{} blocks, check:
      
      1. REQUIRED PROVIDERS (MANDATORY)
         - All providers must be pinned
         - Use ~> for minor version constraints
         - Document why specific versions needed
         - Include source for all providers
      
      2. BACKEND CONFIGURATION (CRITICAL)
         - Remote backend configured (not local)
         - State locking enabled
         - Encryption enabled (if supported)
         - No credentials in backend config
      
      3. TERRAFORM VERSION (MANDATORY)
         - Pin Terraform version
         - Use ~> constraint for minor versions
      
      Flag:
      ```hcl
      # ‚ùå BAD: Multiple issues
      terraform {
        required_providers {
          vsphere = {
            source = "hashicorp/vsphere"
            # No version!
          }
        }
        # No backend!
      }
      ```
      
      Require:
      ```hcl
      # ‚úÖ GOOD: Complete configuration
      terraform {
        required_version = "~> 1.6"
        
        required_providers {
          vsphere = {
            source  = "hashicorp/vsphere"
            version = "~> 2.5"
          }
          proxmox = {
            source  = "telmate/proxmox"
            version = "~> 2.9"
          }
        }
        
        backend "consul" {
          address = var.consul_address
          path    = "terraform/${var.project}/${var.environment}"
          lock    = true
        }
        
        # OR for GitLab/GitHub:
        backend "http" {
          address        = "https://gitlab.com/api/v4/projects/123/terraform/state/mystate"
          lock_address   = "https://gitlab.com/api/v4/projects/123/terraform/state/mystate/lock"
          unlock_address = "https://gitlab.com/api/v4/projects/123/terraform/state/mystate/lock"
          lock_method    = "POST"
          unlock_method  = "DELETE"
        }
      }
      ```
  
  # Module files
  - path: "**/modules/**/*.tf"
    instructions: |
      For module files, check:
      
      1. MODULE STRUCTURE:
         - README.md exists
         - versions.tf exists
         - variables.tf with all descriptions
         - outputs.tf with all descriptions
         - examples/ directory exists
      
      2. MODULE INPUTS:
         - All variables documented
         - Validation rules present
         - Sensible defaults where appropriate
         - No required variables for optional features
      
      3. MODULE OUTPUTS:
         - Output everything consumers might need
         - Document all outputs
         - Mark secrets sensitive
      
      4. MODULE VERSIONING:
         - Pin provider versions in module
         - Document version constraints
         - Use semantic versioning for module releases
      
      5. EXAMPLES:
         - Include examples/ directory
         - Show common use cases
         - Make examples runnable
      
      Flag modules without:
      - README.md
      - examples/
      - Variable descriptions
      - Output descriptions
      - Version constraints
  
  # tfvars files
  - path: "**/*.tfvars"
    instructions: |
      For tfvars files, check:
      
      1. NO SECRETS (CRITICAL)
         - Never commit secrets to tfvars
         - Use environment variables or vault
         - Add *.tfvars to .gitignore if contains secrets
      
      2. ENVIRONMENT-SPECIFIC:
         - Different tfvars per environment
         - Clear naming: dev.tfvars, prod.tfvars
         - Document differences
      
      3. DOCUMENTATION:
         - Comment non-obvious values
         - Explain why specific values chosen
         - Reference related documentation
      
      Flag:
      ```hcl
      # ‚ùå CRITICAL: Secret in tfvars
      api_token = "secret123"
      password  = "MyPassword!"
      ```
      
      Require:
      ```hcl
      # ‚úÖ GOOD: No secrets, documented
      # VM configuration for production environment
      # See docs/infrastructure.md for sizing decisions
      
      vm_count      = 5
      vm_cpu_cores  = 4
      vm_memory_gb  = 16
      
      # Network configuration - production VLAN
      network_id = "vlan-100"
      
      # Secrets set via environment variables:
      # export TF_VAR_api_token=$(vault read -field=token secret/prod/api)
      # export TF_VAR_password=$(vault read -field=password secret/prod/db)
      ```
  
  # Provider configuration files
  - path: "**/*provider*.tf"
    instructions: |
      For provider configuration, check:
      
      1. NO HARDCODED CREDENTIALS:
         - Never hardcode username/password
         - Use variables or environment variables
         - Reference vault/secrets manager
      
      2. PROVIDER CONFIGURATION:
         - Use variables for endpoints
         - Document provider requirements
         - Use default_tags when available
      
      Flag:
      ```hcl
      # ‚ùå CRITICAL: Hardcoded credentials
      provider "vsphere" {
        user     = "administrator@vsphere.local"
        password = "MyPassword123!"
        vsphere_server = "vcenter.example.com"
      }
      ```
      
      Require:
      ```hcl
      # ‚úÖ GOOD: Variables for credentials
      provider "vsphere" {
        user           = var.vsphere_user
        password       = var.vsphere_password
        vsphere_server = var.vsphere_server
        
        # Optional: Skip cert verification for dev
        allow_unverified_ssl = var.environment != "prod"
      }
      
      # Variables defined elsewhere:
      variable "vsphere_user" {
        description = "vSphere username (use TF_VAR_vsphere_user)"
        type        = string
        sensitive   = true
      }
      ```

# Custom review instructions
custom_review_instructions: |
  This is a Terraform infrastructure-as-code repository (provider-agnostic).
  
  CRITICAL FOCUS AREAS (Universal to all providers):
  
  1. SECRETS MANAGEMENT (CRITICAL)
     - NEVER allow hardcoded secrets
     - All secrets must use sensitive = true
     - Check passwords, API tokens, SSH keys, certificates
     - Flag any credentials in code
  
  2. TERRAFORM BEST PRACTICES
     - for_each over count (always)
     - Variable validation (when appropriate)
     - Descriptions on all variables/outputs
     - Lifecycle rules on critical resources
     - Resource naming conventions
     - Tags/labels on all resources
  
  3. STATE MANAGEMENT (CRITICAL)
     - Remote backend configured
     - State locking enabled
     - No state files in git
     - Encryption where supported
  
  4. MODULE QUALITY
     - README with usage examples
     - All variables documented
     - All outputs documented
     - Version constraints
     - Examples directory
  
  5. CODE ORGANIZATION
     - Logical file structure
     - Consistent naming
     - Clear resource dependencies
     - Minimal use of provisioners
     - No null_resource abuse
  
  6. VERSION MANAGEMENT
     - Terraform version pinned
     - Provider versions pinned
     - Use ~> for minor version updates
     - Document version requirements
  
  7. DOCUMENTATION
     - Variable descriptions
     - Output descriptions
     - Complex logic commented
     - Module README files
     - Architecture decisions documented
  
  PROVIDER-AGNOSTIC MEANS:
  - Don't assume cloud providers (AWS/Azure/GCP)
  - Focus on Terraform fundamentals
  - Check vSphere, Proxmox, on-prem patterns
  - Universal security principles
  - Code quality over provider specifics

# Tone settings
tone_instructions: |
  - Be direct about security issues (CRITICAL, ERROR, WARNING)
  - Explain WHY it matters (blast radius, maintainability)
  - Provide concrete fixes with code examples
  - For secrets: Explain where they'll be exposed (git, state, logs)
  - For best practices: Explain the pain of not following them
  - Use emojis: üîê security, üí• breaking change, ‚ö†Ô∏è warning, ‚ùå error, ‚úÖ good

# Additional instructions for specific file types
file_type_instructions:
  terraform:
    - "Check for hardcoded secrets (passwords, tokens, keys)"
    - "Validate for_each used instead of count"
    - "Verify all variables have descriptions and validation"
    - "Check lifecycle rules on critical resources"
    - "Validate resource naming conventions"
    - "Check tags/labels on all resources"
    - "Verify depends_on is justified"
    - "Flag provisioner usage"
    - "Check dynamic block complexity"

# Disable specific checks
disable_checks:
  # Allow long lines for complex expressions
  - "terraform-line-too-long-for-expressions"

# PR title validation
pull_requests:
  title_pattern: "^(feat|fix|docs|refactor|chore)(\\(.+\\))?: .+"
  title_pattern_error: |
    PR title must follow conventional commits format:
    feat(vm): add production web servers
    fix(network): correct VLAN configuration
    docs: update deployment guide

# Knowledge base
knowledge_base:
  learnings:
    enabled: true
    scope: "repository"
  opt_in: true

# Chat settings
chat:
  auto_reply: true
